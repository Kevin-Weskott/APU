<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apontamento de Produção</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <!-- SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
      color: #333;
    }
    .login-container, .apontamento-container {
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 2rem;
      margin: 2rem auto;
      max-width: 1200px;
    }
    .login-container h2, .apontamento-container h1 {
      color: #28a745;
      font-weight: bold;
    }
    .form-control, .form-select {
      border-radius: 8px;
      padding: 10px;
      border: 1px solid #ddd;
    }
    .form-control:focus, .form-select:focus {
      border-color: #28a745;
      box-shadow: 0 0 5px rgba(40, 167, 69, 0.5);
    }
    .btn-custom {
      background-color: #28a745;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      font-size: 16px;
      transition: background-color 0.3s ease;
    }
    .btn-custom:hover {
      background-color: #218838;
    }
    .btn-danger {
      background-color: #dc3545;
    }
    .btn-danger:hover {
      background-color: #c82333;
    }
    .summary, .report-section, .history-section {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
      border: 1px solid #ddd;
    }
    .history-entry {
      background-color: #fff;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      border: 1px solid #ddd;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Tela de Login -->
  <div class="login-container" id="loginContainer">
    <h2>Login</h2>
    <div class="mb-3">
      <label for="username" class="form-label">Usuário</label>
      <input type="text" id="username" class="form-control" placeholder="Usuário" required>
    </div>
    <div class="mb-3">
      <label for="password" class="form-label">Senha</label>
      <input type="password" id="password" class="form-control" placeholder="Senha" required>
    </div>
    <button class="btn btn-custom w-100" onclick="login()">Entrar</button>
    <div class="mt-3 text-center">
      <a href="#" onclick="showRecoverPassword()" class="text-decoration-none">Esqueci minha senha</a> |
      <a href="#" onclick="showSignUp()" class="text-decoration-none">Criar conta</a>
    </div>
    <div class="feedback mt-3 text-danger" id="feedback"></div>
  </div>

  <!-- Página de Apontamentos (inicialmente oculta) -->
  <div class="apontamento-container hidden" id="apontamentoContainer">
    <h1>Apontamento de Produção</h1>
    <form id="apontamentoForm">
      <!-- Campos do formulário -->
      <div class="mb-3">
        <label for="date" class="form-label">Data</label>
        <input type="date" id="date" class="form-control" required>
      </div>
      <div class="mb-3">
        <label for="operator" class="form-label">Operador</label>
        <input type="text" id="operator" class="form-control" oninput="formatUpperCase(this)" required>
      </div>
      <div class="mb-3">
        <label for="cnc" class="form-label">CNC</label>
        <select id="cnc" class="form-select" required>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="client" class="form-label">Cliente</label>
        <input type="text" id="client" class="form-control" oninput="formatUpperCase(this)" required>
      </div>
      <div class="mb-3">
        <label for="pv" class="form-label">Ordem de Produção</label>
        <input type="text" id="pv" class="form-control" oninput="formatNumbers(this)" required>
      </div>
      <div class="mb-3">
        <label for="productCode" class="form-label">Código do Produto</label>
        <input type="text" id="productCode" class="form-control" oninput="formatNumbers(this)" required>
      </div>
      <div class="mb-3">
        <label for="sheetsPerHour" class="form-label">Chapas por Hora (Capacidade Máxima)</label>
        <input type="number" id="sheetsPerHour" class="form-control" required>
      </div>
      <div class="mb-3">
        <label for="flangesPerSheet" class="form-label">Flanges por Chapa</label>
        <input type="number" id="flangesPerSheet" class="form-control" required>
      </div>
      <div class="mb-3">
        <label for="cutSheets" class="form-label">Chapas Cortadas (Real)</label>
        <input type="number" id="cutSheets" class="form-control" required>
      </div>
      <div class="mb-3">
        <label for="deadFlanges" class="form-label">Flanges Mortas</label>
        <input type="number" id="deadFlanges" class="form-control" required>
      </div>

      <!-- Apontamento de Paradas -->
      <div class="stops-section mb-3">
        <h3>Apontamento de Paradas</h3>
        <div class="mb-3">
          <label for="startEndProduction" class="form-label">( I ) - Início e Final de Produção (minutos)</label>
          <input type="number" id="startEndProduction" class="form-control" value="0" required>
        </div>
        <div class="mb-3">
          <label for="idleTime" class="form-label">( O ) - Ociosidade (minutos)</label>
          <input type="number" id="idleTime" class="form-control" value="0" required>
        </div>
        <div class="mb-3">
          <label for="technicalProblems" class="form-label">( P ) - Problemas Técnicos (minutos)</label>
          <input type="number" id="technicalProblems" class="form-control" value="0" required>
        </div>
        <div class="mb-3">
          <label for="externalResponsibility" class="form-label">( R ) - Responsabilidade Externa (minutos)</label>
          <input type="number" id="externalResponsibility" class="form-control" value="0" required>
        </div>
        <div class="mb-3">
          <label for="lackOfManpower" class="form-label">( MO ) - Falta MO (minutos)</label>
          <input type="number" id="lackOfManpower" class="form-control" value="0" required>
        </div>
        <div class="mb-3">
          <label for="supply" class="form-label">( ABS ) - Abastecimento (minutos)</label>
          <input type="number" id="supply" class="form-control" value="0" required>
        </div>
        <div class="mb-3">
          <label for="drumDisposal" class="form-label">( DT ) - Descarte Tambores (minutos)</label>
          <input type="number" id="drumDisposal" class="form-control" value="0" required>
        </div>
        <div class="mb-3">
          <label for="sacrificialSheetChange" class="form-label">( TCS ) - Troca Chapa de Sacrifício (minutos)</label>
          <input type="number" id="sacrificialSheetChange" class="form-control" value="0" required>
        </div>
        <div class="mb-3">
          <label for="programAdjustment" class="form-label">( PR ) - Ajuste ou Falta de Programa (minutos)</label>
          <input type="number" id="programAdjustment" class="form-control" value="0" required>
        </div>
      </div>

      <button type="button" class="btn btn-custom" onclick="saveEntry()">
        <i class="bi bi-save"></i> Salvar Apontamento
      </button>
      <button type="button" class="btn btn-danger" onclick="clearForm()">
        <i class="bi bi-x-circle"></i> Limpar Campos
      </button>
    </form>

    <!-- Resumo -->
    <div id="summary" class="summary"></div>

    <!-- Histórico -->
    <div class="history">
      <h2>Histórico de Apontamentos</h2>
      <button class="btn btn-custom" onclick="toggleHistory()">
        <i class="bi bi-clock-history"></i> Exibir Histórico
      </button>
      <div id="historyResult" class="history-section"></div>
    </div>

    <!-- Relatório -->
    <div class="report">
      <h2>Relatório Diário</h2>
      <button class="btn btn-custom" onclick="generateReport()">
        <i class="bi bi-file-earmark-text"></i> Gerar Relatório
      </button>
      <button class="btn btn-success" onclick="exportToExcel()">
        <i class="bi bi-file-earmark-excel"></i> Exportar para Excel
      </button>
      <button class="btn btn-warning" onclick="exportToPDF()">
        <i class="bi bi-file-earmark-pdf"></i> Exportar para PDF
      </button>
      <div id="reportResult"></div>
    </div>
  </div>

  <script>
    // Configuração do Supabase
    const supabaseUrl = 'https://cvtgxzeelrgcyphyycjk.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2dGd4emVlbHJnY3lwaHl5Y2prIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1MjkyNjUsImV4cCI6MjA1NjEwNTI2NX0.5LfIoblR6QPzJeiNuHfhTE0p-O3urNpyKaKPzAKMqdk';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    let entries = [];
    let attempts = 0;

    // Função de login
    function login() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const feedback = document.getElementById('feedback');

      // Verificação simples de usuário e senha
      if (username === "admin" && password === "1234") {
        // Oculta a tela de login e exibe a página de apontamentos
        document.getElementById('loginContainer').classList.add('hidden');
        document.getElementById('apontamentoContainer').classList.remove('hidden');
        feedback.textContent = "";
        loadEntries(); // Carrega os apontamentos ao fazer login
      } else {
        attempts++;
        if (attempts >= 3) {
          feedback.textContent = "Conta bloqueada. Tente novamente mais tarde.";
          document.querySelector('button').disabled = true;
        } else {
          feedback.textContent = "Usuário ou senha incorretos!";
        }
      }
    }

    // Função para exibir tela de recuperação de senha
    function showRecoverPassword() {
      alert("Funcionalidade de recuperação de senha em desenvolvimento.");
    }

    // Função para exibir tela de cadastro
    function showSignUp() {
      alert("Funcionalidade de cadastro em desenvolvimento.");
    }

    // Função para formatar texto em maiúsculas
    function formatUpperCase(input) {
      input.value = input.value.toUpperCase();
    }

    // Função para permitir apenas números
    function formatNumbers(input) {
      input.value = input.value.replace(/[^0-9]/g, '');
    }

    // Função para validar campos
    function validateFields() {
      const requiredFields = [
        'date', 'operator', 'cnc', 'client', 'pv', 'productCode',
        'sheetsPerHour', 'flangesPerSheet', 'cutSheets', 'deadFlanges',
        'startEndProduction', 'idleTime', 'technicalProblems', 'externalResponsibility',
        'lackOfManpower', 'supply', 'drumDisposal', 'sacrificialSheetChange', 'programAdjustment'
      ];

      for (const fieldId of requiredFields) {
        const field = document.getElementById(fieldId);
        if (!field.value && field.value !== '0') {
          alert(`O campo ${fieldId} é obrigatório!`);
          return false;
        }
        if (field.type === 'number' && field.value < 0) {
          alert(`O campo ${fieldId} não pode ser negativo!`);
          return false;
        }
      }

      const dateField = document.getElementById('date');
      const selectedDate = new Date(dateField.value);
      const today = new Date();
      if (selectedDate > today) {
        alert("A data não pode ser futura!");
        return false;
      }

      return true;
    }

    // Função para salvar o apontamento no Supabase
    async function saveEntry() {
      if (!validateFields()) return;

      const entry = {
        date: document.getElementById('date').value,
        operator: document.getElementById('operator').value,
        cnc: document.getElementById('cnc').value,
        client: document.getElementById('client').value,
        pv: document.getElementById('pv').value,
        productCode: document.getElementById('productCode').value,
        sheetsPerHour: parseInt(document.getElementById('sheetsPerHour').value),
        flangesPerSheet: parseInt(document.getElementById('flangesPerSheet').value),
        cutSheets: parseInt(document.getElementById('cutSheets').value),
        deadFlanges: parseInt(document.getElementById('deadFlanges').value),
        startEndProduction: parseInt(document.getElementById('startEndProduction').value),
        idleTime: parseInt(document.getElementById('idleTime').value),
        technicalProblems: parseInt(document.getElementById('technicalProblems').value),
        externalResponsibility: parseInt(document.getElementById('externalResponsibility').value),
        lackOfManpower: parseInt(document.getElementById('lackOfManpower').value),
        supply: parseInt(document.getElementById('supply').value),
        drumDisposal: parseInt(document.getElementById('drumDisposal').value),
        sacrificialSheetChange: parseInt(document.getElementById('sacrificialSheetChange').value),
        programAdjustment: parseInt(document.getElementById('programAdjustment').value)
      };

      // Salva no Supabase
      const { data, error } = await supabase
        .from('apontamentos')
        .insert([entry]);

      if (error) {
        alert("Erro ao salvar o apontamento: " + error.message);
        return;
      }

      entries.push(entry);
      updateSummary(entry);
      updateHistory();
      clearForm();
      alert("Apontamento salvo com sucesso!");
    }

    // Função para carregar os apontamentos do Supabase
    async function loadEntries() {
      const { data, error } = await supabase
        .from('apontamentos')
        .select('*');

      if (error) {
        alert("Erro ao carregar apontamentos: " + error.message);
        return;
      }

      entries = data;
      updateHistory();
    }

    // Função para atualizar o resumo
    function updateSummary(entry) {
      const efficiency = (entry.cutSheets / entry.sheetsPerHour) * 100;
      const summary = `
        <h3>Resumo da Hora:</h3>
        <p>Quantidade que deveria cortar: ${entry.sheetsPerHour}</p>
        <p>Quantidade cortada: ${entry.cutSheets}</p>
        <p>Eficiência: ${efficiency.toFixed(2)}%</p>
      `;
      document.getElementById('summary').innerHTML = summary;
    }

    // Função para alternar a visibilidade do histórico
    function toggleHistory() {
      const historySection = document.getElementById('historyResult');
      historySection.style.display = historySection.style.display === 'none' ? 'block' : 'none';
      if (historySection.style.display === 'block') {
        updateHistory();
      }
    }

    // Função para atualizar o histórico
    function updateHistory() {
      const historyResult = document.getElementById('historyResult');
      historyResult.innerHTML = '<h3>Últimos Apontamentos:</h3>';

      entries.slice(-5).forEach((entry, index) => {
        const historyEntry = `
          <div class="history-entry">
            <p><strong>Apontamento ${index + 1}:</strong></p>
            <p>Data: ${entry.date} | CNC: ${entry.cnc} | Operador: ${entry.operator}</p>
            <p>Cliente: ${entry.client} | PV: ${entry.pv} | Código: ${entry.productCode}</p>
            <p>Chapas Cortadas: ${entry.cutSheets} | Eficiência: ${((entry.cutSheets / entry.sheetsPerHour) * 100).toFixed(2)}%</p>
          </div>
        `;
        historyResult.innerHTML += historyEntry;
      });
    }

    // Função para limpar o formulário
    function clearForm() {
      const fields = [
        'date', 'operator', 'cnc', 'client', 'pv', 'productCode',
        'sheetsPerHour', 'flangesPerSheet', 'cutSheets', 'deadFlanges',
        'startEndProduction', 'idleTime', 'technicalProblems', 'externalResponsibility',
        'lackOfManpower', 'supply', 'drumDisposal', 'sacrificialSheetChange', 'programAdjustment'
      ];

      fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        field.value = field.type === 'select-one' ? '1' : '';
      });

      document.getElementById('summary').innerHTML = '';
    }

    // Função para gerar o relatório diário
    function generateReport() {
      if (entries.length === 0) {
        alert("Nenhum apontamento registrado ainda!");
        return;
      }

      const groupedEntries = entries.reduce((acc, entry) => {
        if (!acc[entry.date]) acc[entry.date] = {};
        if (!acc[entry.date][entry.cnc]) acc[entry.date][entry.cnc] = [];
        acc[entry.date][entry.cnc].push(entry);
        return acc;
      }, {});

      let report = '';
      let totals = { cutSheets: 0, deadFlanges: 0, capacity: 0, flangesProduced: 0, hoursWorked: 0, hoursStopped: 0 };

      for (const date in groupedEntries) {
        report += `<div class="report-section"><h3>Data: ${date}</h3>`;

        for (const cnc in groupedEntries[date]) {
          const cncEntries = groupedEntries[date][cnc];
          const cncTotals = cncEntries.reduce((acc, entry) => ({
            cutSheets: acc.cutSheets + entry.cutSheets,
            deadFlanges: acc.deadFlanges + entry.deadFlanges,
            capacity: acc.capacity + entry.sheetsPerHour,
            flangesProduced: acc.flangesProduced + (entry.cutSheets * entry.flangesPerSheet),
            hoursWorked: acc.hoursWorked + 1,
            hoursStopped: acc.hoursStopped + (
              entry.startEndProduction + entry.idleTime + entry.technicalProblems +
              entry.externalResponsibility + entry.lackOfManpower + entry.supply +
              entry.drumDisposal + entry.sacrificialSheetChange + entry.programAdjustment
            ) / 60 // Convertendo minutos para horas
          }), { cutSheets: 0, deadFlanges: 0, capacity: 0, flangesProduced: 0, hoursWorked: 0, hoursStopped: 0 });

          report += `
            <h4>CNC: ${cnc}</h4>
            <p>Horas Trabalhadas: ${cncTotals.hoursWorked}</p>
            <p>Horas Paradas: ${cncTotals.hoursStopped.toFixed(2)}</p>
            <p>Capacidade Máxima (Chapas por Hora): ${cncTotals.capacity}</p>
            <p>Chapas Cortadas (Real): ${cncTotals.cutSheets}</p>
            <p>Flanges Cortadas: ${cncTotals.flangesProduced}</p>
            <p>Eficiência: ${((cncTotals.cutSheets / cncTotals.capacity) * 100).toFixed(2)}%</p>
            <p>Total de Flanges Mortas: ${cncTotals.deadFlanges}</p>
          `;

          Object.keys(totals).forEach(key => totals[key] += cncTotals[key]);
        }

        report += `</div>`;
      }

      // Total Consolidado dos 3 CNCs
      report += `<div class="report-section"><h3>Total Consolidado dos 3 CNCs</h3>`;
      report += `
        <p>Horas Trabalhadas: ${totals.hoursWorked}</p>
        <p>Horas Paradas: ${totals.hoursStopped.toFixed(2)}</p>
        <p>Capacidade Máxima (Chapas por Hora): ${totals.capacity}</p>
        <p>Chapas Cortadas (Real): ${totals.cutSheets}</p>
        <p>Flanges Cortadas: ${totals.flangesProduced}</p>
        <p>Eficiência: ${((totals.cutSheets / totals.capacity) * 100).toFixed(2)}%</p>
        <p>Total de Flanges Mortas: ${totals.deadFlanges}</p>
      `;
      report += `</div>`;

      document.getElementById('reportResult').innerHTML = report;
    }

    // Função para exportar para Excel
    function exportToExcel() {
      if (entries.length === 0) {
        alert("Nenhum apontamento registrado ainda!");
        return;
      }

      const worksheetData = entries.map(entry => [
        entry.date,
        entry.operator,
        entry.cnc,
        entry.client,
        entry.pv,
        entry.productCode,
        entry.sheetsPerHour,
        entry.flangesPerSheet,
        entry.cutSheets,
        entry.deadFlanges,
        entry.startEndProduction,
        entry.idleTime,
        entry.technicalProblems,
        entry.externalResponsibility,
        entry.lackOfManpower,
        entry.supply,
        entry.drumDisposal,
        entry.sacrificialSheetChange,
        entry.programAdjustment
      ]);

      const worksheet = XLSX.utils.aoa_to_sheet([
        ["Data", "Operador", "CNC", "Cliente", "Ordem de Produção", "Código do Produto", "Chapas por Hora", "Flanges por Chapa", "Chapas Cortadas", "Flanges Mortas",
         "( I ) - Início e Final de Produção (minutos)", "( O ) - Ociosidade (minutos)", "( P ) - Problemas Técnicos (minutos)", "( R ) - Responsabilidade Externa (minutos)",
         "( MO ) - Falta MO (minutos)", "( ABS ) - Abastecimento (minutos)", "( DT ) - Descarte Tambores (minutos)", "( TCS ) - Troca Chapa de Sacrifício (minutos)", "( PR ) - Ajuste ou Falta de Programa (minutos)"],
        ...worksheetData
      ]);

      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "Apontamentos");

      XLSX.writeFile(workbook, "apontamentos.xlsx");
    }

    // Função para exportar para PDF
    function exportToPDF() {
      if (entries.length === 0) {
        alert("Nenhum apontamento registrado ainda!");
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Título do relatório
      doc.setFontSize(18);
      doc.text("Relatório Diário de Apontamentos", 10, 10);

      // Conteúdo do relatório
      let y = 20;
      const groupedEntries = entries.reduce((acc, entry) => {
        if (!acc[entry.date]) acc[entry.date] = {};
        if (!acc[entry.date][entry.cnc]) acc[entry.date][entry.cnc] = [];
        acc[entry.date][entry.cnc].push(entry);
        return acc;
      }, {});

      for (const date in groupedEntries) {
        doc.setFontSize(14);
        doc.text(`Data: ${date}`, 10, y);
        y += 10;

        for (const cnc in groupedEntries[date]) {
          const cncEntries = groupedEntries[date][cnc];
          const cncTotals = cncEntries.reduce((acc, entry) => ({
            cutSheets: acc.cutSheets + entry.cutSheets,
            deadFlanges: acc.deadFlanges + entry.deadFlanges,
            capacity: acc.capacity + entry.sheetsPerHour,
            flangesProduced: acc.flangesProduced + (entry.cutSheets * entry.flangesPerSheet),
            hoursWorked: acc.hoursWorked + 1,
            hoursStopped: acc.hoursStopped + (
              entry.startEndProduction + entry.idleTime + entry.technicalProblems +
              entry.externalResponsibility + entry.lackOfManpower + entry.supply +
              entry.drumDisposal + entry.sacrificialSheetChange + entry.programAdjustment
            ) / 60 // Convertendo minutos para horas
          }), { cutSheets: 0, deadFlanges: 0, capacity: 0, flangesProduced: 0, hoursWorked: 0, hoursStopped: 0 });

          doc.setFontSize(12);
          doc.text(`CNC: ${cnc}`, 15, y);
          y += 7;
          doc.text(`Horas Trabalhadas: ${cncTotals.hoursWorked}`, 20, y);
          y += 7;
          doc.text(`Horas Paradas: ${cncTotals.hoursStopped.toFixed(2)}`, 20, y);
          y += 7;
          doc.text(`Capacidade Máxima (Chapas por Hora): ${cncTotals.capacity}`, 20, y);
          y += 7;
          doc.text(`Chapas Cortadas (Real): ${cncTotals.cutSheets}`, 20, y);
          y += 7;
          doc.text(`Flanges Cortadas: ${cncTotals.flangesProduced}`, 20, y);
          y += 7;
          doc.text(`Eficiência: ${((cncTotals.cutSheets / cncTotals.capacity) * 100).toFixed(2)}%`, 20, y);
          y += 7;
          doc.text(`Total de Flanges Mortas: ${cncTotals.deadFlanges}`, 20, y);
          y += 10;
        }
      }

      // Total Consolidado dos 3 CNCs
      const totals = entries.reduce((acc, entry) => ({
        cutSheets: acc.cutSheets + entry.cutSheets,
        deadFlanges: acc.deadFlanges + entry.deadFlanges,
        capacity: acc.capacity + entry.sheetsPerHour,
        flangesProduced: acc.flangesProduced + (entry.cutSheets * entry.flangesPerSheet),
        hoursWorked: acc.hoursWorked + 1,
        hoursStopped: acc.hoursStopped + (
          entry.startEndProduction + entry.idleTime + entry.technicalProblems +
          entry.externalResponsibility + entry.lackOfManpower + entry.supply +
          entry.drumDisposal + entry.sacrificialSheetChange + entry.programAdjustment
        ) / 60 // Convertendo minutos para horas
      }), { cutSheets: 0, deadFlanges: 0, capacity: 0, flangesProduced: 0, hoursWorked: 0, hoursStopped: 0 });

      doc.setFontSize(14);
      doc.text("Total Consolidado dos 3 CNCs", 10, y);
      y += 10;
      doc.setFontSize(12);
      doc.text(`Horas Trabalhadas: ${totals.hoursWorked}`, 15, y);
      y += 7;
      doc.text(`Horas Paradas: ${totals.hoursStopped.toFixed(2)}`, 15, y);
      y += 7;
      doc.text(`Capacidade Máxima (Chapas por Hora): ${totals.capacity}`, 15, y);
      y += 7;
      doc.text(`Chapas Cortadas (Real): ${totals.cutSheets}`, 15, y);
      y += 7;
      doc.text(`Flanges Cortadas: ${totals.flangesProduced}`, 15, y);
      y += 7;
      doc.text(`Eficiência: ${((totals.cutSheets / totals.capacity) * 100).toFixed(2)}%`, 15, y);
      y += 7;
      doc.text(`Total de Flanges Mortas: ${totals.deadFlanges}`, 15, y);

      // Salvar o PDF
      doc.save("relatorio_diario.pdf");
    }
  </script>
</body>
</html>
